---
version: '3.5'
services:

  memoriam-gateway:
    build:
      context: ../
    environment:
      DEBUG: 1
      GATEWAY_WORKERS: 2
      GATEWAY_TLS: 1
      AUTHLY_SERVICENAME: testservice
      AUTHLY_SERVICESECRET: secret
      CERT_FILE: /srv/memoriam/server.pem
      KEY_FILE: /srv/memoriam/server.key
      CA_FILE: ''
    volumes:
      - ./certs/server.pem:/srv/memoriam/server.pem:ro
      - ./certs/server.key:/srv/memoriam/server.key:ro
    ports:
      - 5001:5001
    command: memoriam gateway

  memoriam-domain:
    build:
      context: ../
    environment:
      AUTHLY_SERVICENAME: testservice
      AUTHLY_SERVICESECRET: secret
      ARANGO_DOMAIN_DB_NAME: memoriam_test
      ARANGO_DB_NAME: memoriam_test
      ARANGO_SCHEMA_PATH: /srv/memoriam/db_schema.yml
      DOMAIN_SCHEMA_PATH: /srv/memoriam/domain_schema.yml
      SEARCH_CONFIG_PATH: /srv/memoriam/search_config.yml
      SERVICE_CONFIG_PATH: /srv/memoriam/service_config.yml
      DEBUG: 1
      AUDIT_LOG: 1
      AUDIT_LOG_DB: 1
      AUDIT_VERSIONING: 1
      DOMAIN_WORKERS: 2
    volumes:
      - ./data/test_schema_integration.yml:/srv/memoriam/db_schema.yml:ro
      - ./data/test_domain_infoflow.yml:/srv/memoriam/domain_schema.yml:ro
      - ./data/test_search_config.yml:/srv/memoriam/search_config.yml:ro
      - ./data/test_service_config.yml:/srv/memoriam/service_config.yml:ro
    ports:
      - 5002:5002
    command: memoriam domain

  memoriam-storage:
    build:
      context: ../
    environment:
      ARANGO_DOMAIN_DB_NAME: memoriam_test
      ARANGO_DB_NAME: memoriam_test
      ARANGO_HOSTS: http://coordinator1:8529,http://coordinator2:8529,http://coordinator3:8529
      ARANGO_SCHEMA_PATH: /srv/memoriam/db_schema.yml
      SEARCH_CONFIG_PATH: /srv/memoriam/search_config.yml
      DEBUG: 1
      AUDIT_LOG: 1
      AUDIT_LOG_DB: 1
      AUDIT_VERSIONING: 1
      STORAGE_WORKERS: 2
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: miniosecret
    volumes:
      - ./data/test_schema_integration.yml:/srv/memoriam/db_schema.yml:ro
      - ./data/test_search_config.yml:/srv/memoriam/search_config.yml:ro
    ports:
      - 5003:5003
    command: memoriam storage

  authly:
    image: protojour/authly:0.17.1
    depends_on:
      - redis
    environment:
      PORT: 5004
      REDIS_HOST: redis

  agent1:
    image: arangodb:3.11
    environment:
      ARANGO_NO_AUTH: 1
    command: arangod
      --server.endpoint tcp://0.0.0.0:8531
      --agency.my-address tcp://agent1:8531
      --server.authentication false
      --agency.activate true
      --agency.size 3
      --agency.supervision true
      --database.directory /var/lib/arangodb3

  agent2:
    image: arangodb:3.11
    environment:
      ARANGO_NO_AUTH: 1
    command: arangod
      --server.endpoint tcp://0.0.0.0:8531
      --agency.my-address tcp://agent2:8531
      --server.authentication false
      --agency.activate true
      --agency.size 3
      --agency.endpoint tcp://agent1:8531
      --agency.supervision true
      --database.directory /var/lib/arangodb3

  agent3:
    image: arangodb:3.11
    environment:
      ARANGO_NO_AUTH: 1
    command: arangod
      --server.endpoint tcp://0.0.0.0:8531
      --agency.my-address tcp://agent3:8531
      --server.authentication false
      --agency.size 3
      --agency.activate true
      --agency.endpoint tcp://agent1:8531
      --agency.endpoint tcp://agent2:8531
      --agency.endpoint tcp://agent3:8531
      --agency.supervision true
      --database.directory /var/lib/arangodb3

  db1:
    image: arangodb:3.11
    environment:
      ARANGO_NO_AUTH: 1
    command: arangod
      --server.authentication=false
      --server.endpoint tcp://0.0.0.0:8530
      --cluster.my-address tcp://db1:8530
      --cluster.my-local-info db1
      --cluster.my-role DBSERVER
      --cluster.agency-endpoint tcp://agent1:8531
      --cluster.agency-endpoint tcp://agent2:8531
      --cluster.agency-endpoint tcp://agent3:8531
      --database.directory /var/lib/arangodb3

  db2:
    image: arangodb:3.11
    environment:
      ARANGO_NO_AUTH: 1
    command: arangod
      --server.authentication=false
      --server.endpoint tcp://0.0.0.0:8530
      --cluster.my-address tcp://db2:8530
      --cluster.my-local-info db2
      --cluster.my-role DBSERVER
      --cluster.agency-endpoint tcp://agent1:8531
      --cluster.agency-endpoint tcp://agent2:8531
      --cluster.agency-endpoint tcp://agent3:8531
      --database.directory /var/lib/arangodb3

  db3:
    image: arangodb:3.11
    environment:
      ARANGO_NO_AUTH: 1
    command: arangod
      --server.authentication=false
      --server.endpoint tcp://0.0.0.0:8530
      --cluster.my-address tcp://db3:8530
      --cluster.my-local-info db3
      --cluster.my-role DBSERVER
      --cluster.agency-endpoint tcp://agent1:8531
      --cluster.agency-endpoint tcp://agent2:8531
      --cluster.agency-endpoint tcp://agent3:8531
      --database.directory /var/lib/arangodb3

  coordinator1:
    image: arangodb:3.11
    environment:
      ARANGO_NO_AUTH: 1
    command: arangod
      --server.authentication=false
      --server.endpoint tcp://0.0.0.0:8529
      --cluster.my-address tcp://coordinator1:8529
      --cluster.my-local-info coord1
      --cluster.my-role COORDINATOR
      --cluster.agency-endpoint tcp://agent1:8531
      --cluster.agency-endpoint tcp://agent2:8531
      --cluster.agency-endpoint tcp://agent3:8531
      --database.directory /var/lib/arangodb3
    ports: ['8000:8529']

  coordinator2:
    image: arangodb:3.11
    environment:
      ARANGO_NO_AUTH: 1
    command: arangod
      --server.authentication=false
      --server.endpoint tcp://0.0.0.0:8529
      --cluster.my-address tcp://coordinator2:8529
      --cluster.my-local-info coord2
      --cluster.my-role COORDINATOR
      --cluster.agency-endpoint tcp://agent1:8531
      --cluster.agency-endpoint tcp://agent2:8531
      --cluster.agency-endpoint tcp://agent3:8531
      --database.directory /var/lib/arangodb3
    ports: ['8001:8529']

  coordinator3:
    image: arangodb:3.11
    environment:
      ARANGO_NO_AUTH: 1
    command: arangod
      --server.authentication=false
      --server.endpoint tcp://0.0.0.0:8529
      --cluster.my-address tcp://coordinator3:8529
      --cluster.my-local-info coord3
      --cluster.my-role COORDINATOR
      --cluster.agency-endpoint tcp://agent1:8531
      --cluster.agency-endpoint tcp://agent2:8531
      --cluster.agency-endpoint tcp://agent3:8531
      --database.directory /var/lib/arangodb3
    ports: ['8002:8529']

  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: miniosecret
    volumes:
      - test_minio:/data
    ports:
      - 9000:9000
    command: server /data

  redis:
    image: redis:alpine

  test-service:
    build:
      context: .
      dockerfile: Dockerfile.test-service

volumes:
  test_arango:
  test_minio:
